<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="cache-control" content="max-age=3600">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT">
    <meta http-equiv="pragma" content="no-cache">
    <title>Representing Matrix in C++ - Rahul's Backyard
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="Addicted to learning!">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic|Anonymous+Pro:400,700,400italic,700italic|Merriweather:400,700,300">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
  </head>
  <body class="article-detail undefined">
    <header class="header">
      <div class="content-wrap">
        <h1>Representing Matrix in C++</h1>
        <p class="author">Written by <span class="author">Rahul Sharma</span>
        </p>
      </div>
    </header>
    <div id="menu-bar">
      <div class="content-wrap">
      </div>
    </div>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p>Prerequisites: moderate knowledge of C++.
<br/>
Technologies:
<a href="https://en.wikipedia.org/wiki/C%2B%2B" target="_blank">C++</i></a>
<a href="http://quick-bench.com/" target="_blank">Quick-Bench</a></p>
<p><span class="more"></span></p>
<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous">
</script>
<link href="/css/lightbox.min.css" rel="stylesheet">
<script src="/scripts/lightbox.min.js"></script>

<p>This article shows a readable way of representing matrix without loosing performance in C++.</p>
<hr>
<h2 id="table-of-content">Table of content</h2>
<ul>
<li><a href="#the-problem">The Problem</a></li>
<li><a href="#matrix-class">Matrix Class</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<hr>
<h1 id="the-problem">The Problem</h1>

<p>Most of people, who has to deal with the matrices in C++, would be familiar with this problem.</p>
<p>I’m listing two of the most popular ways for representing matrix. One excels in readability while other in performance.</p>
<ul>
<li><p>First way is to use vector of vector.</p>
<pre><code class="language-cpp">  <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; matrix(rows, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;(cols));
  <span class="comment">// do stuff</span>
  <span class="comment">// access like matrix[y][x]</span>
  <span class="comment">// no need to free. RAII rocks.</span></code></pre>
<p>This is similar to using double pointer in C for dynamic 2D array.</p>
<pre><code class="language-cpp">  <span class="keyword">int</span> **matrix = <span class="keyword">new</span> <span class="keyword">int</span>*[rows];
  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++)
      matrix[i] = <span class="keyword">new</span> <span class="keyword">int</span>[cols];
  <span class="comment">// do stuff</span>
  <span class="comment">// access like matrix[y][x]</span>
  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rows; i++)
      <span class="keyword">delete</span> [] matrix[i];
  <span class="keyword">delete</span> [] matrix;</code></pre>
<p>It’s basically an array of arrays. Every element of outer array points to another array of integers. That’s why you can reference it two times. But, since every array is separately allocated, to access the array we must have to go to the elements of outer array first and then inner ones. Also, there will be no guarantee that every row will be adjacent to each other in memory. They can be scattered across the heap.</p>
</li>
<li><p>Second way is to use C style array.</p>
<pre><code class="language-cpp">  <span class="keyword">int</span> matrix = <span class="keyword">new</span> <span class="keyword">int</span>[rows*cols];
  <span class="comment">// do stuff</span>
  <span class="comment">// access like matrix[y*cols+x]</span>
  <span class="keyword">delete</span> [] matrix;</code></pre>
<p>This will make a solid continuous chunk of memory in heap. So, it’ll have a better access time and pattern.</p>
</li>
</ul>
<h2 id="performance">Performance</h2>
<p>C style array access should perform better than vector style access. As, vector style has to refer two times to access an element, the address of matrix (outer array) can be saved in register but elements has to come from memory (or cache). The other problem is that, at the end of a row next row could be anywhere, and pre-fetcher can not predict next fetch.</p>
<p>It’s hard to measure the general performance since the use case varies a lot. But to get some idea I’m considering two types of algorithm with square and rectangular matrices. All the results are compiler on GCC 7.2 with c++14 and -O3 flags on linux x86 machine.
For the simplicity sake we have fixed number of rows and columns but it can be easily changed to general inputs.</p>
<h2 id="sum-of-all-elements">Sum of all elements</h2>
<p>Let us take an example of calculating the sum of all the elements in a matrix. Here are our two popular approaches:</p>
<pre><code class="language-cpp"><span class="comment">// Vector style code for a square matrix</span>
<span class="comment">// Similar thing can be achieved in C by int**</span>
<span class="function"><span class="keyword">int</span> <span class="title">Vector_sum</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;&amp; matrix, <span class="keyword">int</span> N)</span> </span>{
    <span class="keyword">int</span> sum = <span class="number">0</span>;
    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)
        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++)
            sum += matrix[i][j];
    <span class="keyword">return</span> sum;
}</code></pre>
<pre><code class="language-cpp"><span class="comment">// C style code for a square matrix</span>
<span class="function"><span class="keyword">int</span> <span class="title">C_style_sum</span><span class="params">(<span class="keyword">int</span>* matrix, <span class="keyword">int</span> N)</span> </span>{
    <span class="keyword">int</span> sum = <span class="number">0</span>;
    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)
        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++)
            sum += matrix[i * N + j];
    <span class="keyword">return</span> sum;
}</code></pre>
<p>Results for a square matrix of size 512*512
<a href="sum_square_1.png" data-lightbox="sum_1" data-title="Sum of elements (512x512)">
<img src="/articles/representing-matrix-in-cpp/sum_square_1.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/GXUG06sZDLCrGsOogF5wmd2DOFU" target="_blank">quick-bench</a></p>
<p>Results for a rectangular matrix of size 1024*256
<a href="sum_rectangle_1.png" data-lightbox="sum_1" data-title="Sum of elements (1024x256)">
<img src="/articles/representing-matrix-in-cpp/sum_rectangle_1.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/ekNZpPxwiw4wYtqOV51vPF8CXUo" target="_blank">quick-bench</a></p>
<p>As you can see the difference is not much. I can live with that for most of the programs. However, transpose yields a complete different story.</p>
<h2 id="transpose-of-all-elements">Transpose of all elements</h2>
<p>Let us also take an example of transposing a matrix. Which will have completely different access pattern then sum. Here are our two popular approaches:</p>
<pre><code class="language-cpp"><span class="comment">// Vector style code for a square matrix</span>
<span class="comment">// Similar thing can be achieved in C by int**</span>
<span class="keyword">using</span> <span class="keyword">namespace</span> Matrix = <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;;
<span class="function"><span class="keyword">int</span> <span class="title">Vector_transpose</span><span class="params">(Matrix&amp; matrix1, Matrix&amp; matrix2, <span class="keyword">int</span> N)</span> </span>{
    <span class="keyword">int</span> sum = <span class="number">0</span>;
    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)
        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++)
            matrix[i][j] = matrix[j][i];
    <span class="keyword">return</span> sum;
}</code></pre>
<pre><code class="language-cpp"><span class="comment">// C style code for a square matrix</span>
<span class="function"><span class="keyword">int</span> <span class="title">C_style_transpose</span><span class="params">(<span class="keyword">int</span>* matrix1, <span class="keyword">int</span>* matrix2, <span class="keyword">int</span> N)</span> </span>{
    <span class="keyword">int</span> sum = <span class="number">0</span>;
    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)
        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; N; j++)
            matrix2[i * N + j] = matrix1[j * N + i];
    <span class="keyword">return</span> sum;
}</code></pre>
<p>Results for a square matrix of size 512*512
<a href="transpose_square_1.png" data-lightbox="transpose_1" data-title="Transpose of elements (512x512)">
<img src="/articles/representing-matrix-in-cpp/transpose_square_1.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/0DVlD6PAcBQvMmfnjLlJpcSHcls" target="_blank">quick-bench</a></p>
<p>Results for a rectangular matrix of size 1024*256
<a href="transpose_rectangle_1.png" data-lightbox="transpose_1" data-title="Transpose of elements (1024x256)">
<img src="/articles/representing-matrix-in-cpp/transpose_rectangle_1.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/IyZq2RwP_RtZJpC4B8iwTSTSRwI" target="_blank">quick-bench</a></p>
<hr>
<h1 id="matrix-class">Matrix Class</h1>

<p>We can write a custom template class that will allow us to access elements like vector. To achieve we need to overload the brackets operator.</p>
<pre><code class="language-cpp"><span class="comment">// e.g. a matrix of 5 rows and 3 cols</span>
<span class="comment">// matrix&lt;int, 5, 3&gt; x;</span>
<span class="comment">// can be accessed like x[row][col]</span>

<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, <span class="keyword">size_t</span> R, <span class="keyword">size_t</span> C&gt;
<span class="class"><span class="keyword">class</span> <span class="title">matrix</span> {</span>
    T* data; <span class="comment">// can be changed to unique_ptr in C++1z</span>
<span class="keyword">public</span>:
    matrix() : data(<span class="keyword">new</span> T[R*C]) {}

    ~matrix(){ <span class="keyword">delete</span> [] data; }

    <span class="keyword">inline</span> T* <span class="keyword">operator</span>[](<span class="keyword">int</span> row) {
        <span class="keyword">return</span> &amp;data[row * C];
    }

    <span class="keyword">inline</span> <span class="keyword">const</span> T* <span class="keyword">operator</span>[](<span class="keyword">int</span> row) <span class="keyword">const</span> {
        <span class="keyword">return</span> &amp;data[row * C];
    }
};
</code></pre>
<p>Almost all the compilers today can optimize away the referencing and dereferencing of the same array. The assembly code generated by it is virtually same as the C style version.</p>
<p>So, how well it performs.</p>
<h2 id="sum-of-all-elements">Sum of all elements</h2>
<p>Results for a square matrix of size 512*512
<a href="sum_square_2.png" data-lightbox="sum_2" data-title="Sum of elements (512x512)">
<img src="/articles/representing-matrix-in-cpp/sum_square_2.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/UODm6ylUQGqDCGbdxMIUvpqHrcA" target="_blank">quick-bench</a></p>
<p>Results for a rectangular matrix of size 1024*256
<a href="sum_rectangle_2.png" data-lightbox="sum_2" data-title="Sum of elements (1024x256)">
<img src="/articles/representing-matrix-in-cpp/sum_rectangle_2.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/-rGgWT2v0CZsUNbOtoTOCs9ybiE" target="_blank">quick-bench</a></p>
<p>Separate code can be found <a href="sum.cpp" target="_blank">here</a></p>
<h2 id="transpose-of-all-elements">Transpose of all elements</h2>
<p>Results for a square matrix of size 512*512
<a href="transpose_square_2.png" data-lightbox="transpose_2" data-title="Transpose of elements (512x512)">
<img src="/articles/representing-matrix-in-cpp/transpose_square_2.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/VxtU_lR77Fjtm-vo9Vs8CmMDQl4" target="_blank">quick-bench</a></p>
<p>Results for a rectangular matrix of size 1024*256
<a href="transpose_rectangle_2.png" data-lightbox="transpose_2" data-title="Transpose of elements (1024x256)">
<img src="/articles/representing-matrix-in-cpp/transpose_rectangle_2.png" alt="sum benchmark"></a>
See this benchmark on <a href="http://quick-bench.com/PXQl8uW3Dk1R_pBelXFlFCMRxEY" target="_blank">quick-bench</a></p>
<p>Separate code can be found <a href="transpose.cpp" target="_blank">here</a></p>
</section>
        </article>
      </div>
    </div>
    <footer>
      <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-98207720-1', 'auto');
        ga('send', 'pageview');
      </script>
      <div class="content-wrap">
        <div class="nav"><a href="/">&laquo; Home</a></div>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
          var disqus_config = function () {
            this.page.url = 'https://rahulsrma26.github.io/articles/representing-matrix-in-cpp/';
            this.page.identifier = 'Representing Matrix in C++';
          };
          (function() {
            var dsq = document.createElement('script'); 
            dsq.type = 'text/javascript'; 
            dsq.async = true;
            dsq.src = 'https://rahulsrma26-github-io.disqus.com/embed.js';
            dsq.setAttribute('data-timestamp', +new Date());
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
        <noscript>Please enable JavaScript to view the<a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <section class="about"><p>See some of my artwork <a href="/404.html">Hobbies</a>.</p>
<p>Gate 2011 detailed answers <a href="/articles/gate-2011-solution/">Gate-2011-Solution</a></p>
<p><a href="/simulations.html">Simulations/Turing Machine</a></p>
<p><a href="/404.html">Coding funda</a></p>
<p><a href="/404.html">Research</a></p>
<p><a href="/cs/index.html">Slides</a></p>

        </section>
        <section class="copy">
          <p>&copy; 2020 Rahul Sharma &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a></p>
        </section>
      </div>
    </footer>
  </body>
</html>